<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Manifest for Android Install & Background Play -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1db954">
    <title>Music Player</title>
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* --- Spotify-Style Dark Theme --- */
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --sub: #b3b3b3; --accent: #1db954; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* 1. Header */
        .header { padding: 15px; background: rgba(0,0,0,0.9); z-index: 10; box-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        .search-box { display: flex; gap: 10px; background: #333; padding: 6px 12px; border-radius: 30px; }
        input { flex: 1; padding: 8px; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
        .search-btn { background: var(--accent); color: black; border: none; width: 40px; height: 40px; border-radius: 50%; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.1s; }
        .search-btn:active { transform: scale(0.9); }

        /* 2. Main Scrollable Area */
        .main-view { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; align-items: center; }

        /* 3. Player Card */
        .player-card { background: var(--card); border-radius: 12px; padding: 20px; width: 100%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.6); margin-bottom: 25px; display: none; }
        img.cover-art { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); margin-bottom: 20px; }
        .track-info h2 { font-size: 1.3rem; margin: 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-info p { color: var(--sub); font-size: 0.9rem; margin: 5px 0 20px 0; }

        /* 4. Controls */
        .controls { display: flex; align-items: center; justify-content: space-between; padding: 0 10px; }
        .btn-ctrl { background: none; border: none; color: var(--text); font-size: 1.4rem; cursor: pointer; padding: 10px; opacity: 0.7; transition: opacity 0.2s; }
        .btn-ctrl:active { transform: scale(0.9); opacity: 1; }
        .btn-play { background: white; color: black; width: 65px; height: 65px; border-radius: 50%; font-size: 1.8rem; display: flex; align-items: center; justify-content: center; opacity: 1; box-shadow: 0 4px 15px rgba(255,255,255,0.2); }
        .active-mode { color: var(--accent); opacity: 1; text-shadow: 0 0 10px rgba(29,185,84,0.5); }

        /* 5. Playlist / Queue */
        .queue-header { width: 100%; max-width: 400px; color: var(--sub); font-size: 0.85rem; font-weight: bold; letter-spacing: 1px; margin-bottom: 10px; text-transform: uppercase; display: none; }
        .queue-list { width: 100%; max-width: 400px; padding-bottom: 80px; }
        .queue-item { display: flex; align-items: center; gap: 15px; padding: 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .queue-item:active { background: #333; }
        .queue-item.playing { background: rgba(29,185,84,0.1); border-left: 4px solid var(--accent); }
        .queue-item.playing .q-title { color: var(--accent); }
        .q-img { width: 45px; height: 45px; border-radius: 4px; object-fit: cover; }
        .q-info { flex: 1; overflow: hidden; }
        .q-title { font-size: 1rem; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .q-meta { font-size: 0.8rem; color: var(--sub); margin-top: 2px; }

        /* 6. Status Bar */
        .status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: #181818; padding: 12px; text-align: center; color: var(--sub); font-size: 0.85rem; border-top: 1px solid #333; z-index: 20; }
        .loader-line { position: absolute; top: 0; left: 0; height: 3px; background: var(--accent); width: 0%; transition: width 0.3s; display: none; }
        .loader-line.loading { display: block; width: 100%; animation: load 1.5s infinite; }
        @keyframes load { 0% { width: 0; left: 0; } 50% { width: 50%; left: 25%; } 100% { width: 100%; left: 100%; } }

        audio { display: none; }
    </style>
</head>
<body>

    <!-- Search Header -->
    <div class="header">
        <div class="search-box">
            <input type="text" id="query" placeholder="Search song, artist, album..." enterkeyhint="search">
            <button class="search-btn" onclick="performSearch()"><i class="fas fa-search"></i></button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-view">
        <!-- Active Player -->
        <div class="player-card" id="playerUI">
            <img id="pCover" class="cover-art" src="">
            <div class="track-info">
                <h2 id="pTitle">Song Title</h2>
                <p id="pStatus">Ready</p>
            </div>
            
            <div class="controls">
                <button class="btn-ctrl" id="btnRepeat" onclick="toggleRepeat()"><i class="fas fa-repeat"></i></button>
                <button class="btn-ctrl" onclick="playPrev()"><i class="fas fa-backward-step"></i></button>
                <button class="btn-ctrl btn-play" id="btnPlayPause" onclick="togglePlay()"><i class="fas fa-play"></i></button>
                <button class="btn-ctrl" onclick="playNext()"><i class="fas fa-forward-step"></i></button>
                <button class="btn-ctrl" onclick="saveSong()"><i class="fas fa-download"></i></button>
            </div>
        </div>

        <!-- Playlist -->
        <div class="queue-header" id="queueHeader">UP NEXT</div>
        <div class="queue-list" id="queueList"></div>
    </div>

    <!-- Status Footer -->
    <div class="status-bar">
        <div class="loader-line" id="loader"></div>
        <span id="statusText">Search to begin listening</span>
    </div>

    <audio id="player" controls></audio>

    <script>
        const sessionId = "sess_" + Date.now();
        let queue = [];
        let currentIndex = -1;
        let repeatMode = 0; // 0: Off, 1: All, 2: One
        let isPlaying = false;

        // 1. Initialize PWA Background Engine
        if ('serviceWorker' in navigator) {
            // Only register in secure/local contexts
            if (['https:', 'http:', 'localhost'].includes(window.location.protocol.split(':')[0])) {
                navigator.serviceWorker.register('/sw.js').catch(console.error);
            }
        }

        // --- SEARCH FUNCTION ---
        async function performSearch() {
            const q = document.getElementById('query').value.trim();
            if(!q) return;

            document.getElementById('query').blur();
            setStatus("Searching...", true);
            
            try {
                // Fetch list of results (Artist/Album/Similar)
                const res = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({query: q})
                });
                const data = await res.json();
                
                if(data.results && data.results.length > 0) {
                    queue = data.results;
                    renderQueue();
                    setStatus(`Found ${queue.length} tracks.`, false);
                    // Automatically load the first song
                    loadSong(0);
                } else {
                    setStatus("No songs found.", false);
                }
            } catch(e) { setStatus("Network Error. Check VPN.", false); }
        }

        // --- RENDER QUEUE ---
        function renderQueue() {
            const list = document.getElementById('queueList');
            list.innerHTML = "";
            document.getElementById('queueHeader').style.display = 'block';
            
            queue.forEach((track, index) => {
                const item = document.createElement('div');
                item.className = `queue-item ${index === currentIndex ? 'playing' : ''}`;
                item.onclick = () => loadSong(index);
                item.innerHTML = `
                    <img src="${track.thumbnail}" class="q-img">
                    <div class="q-info">
                        <div class="q-title">${track.title}</div>
                        <div class="q-meta">${index === currentIndex ? 'Now Playing' : track.duration || 'Track'}</div>
                    </div>
                    ${index === currentIndex ? '<i class="fas fa-volume-high" style="color:var(--accent)"></i>' : ''}
                `;
                list.appendChild(item);
            });
        }

        // --- LOAD & BUFFER SONG ---
        async function loadSong(index) {
            if(index < 0 || index >= queue.length) return;
            currentIndex = index;
            const track = queue[index];

            // Update UI
            document.getElementById('playerUI').style.display = 'block';
            document.getElementById('pCover').src = track.thumbnail;
            document.getElementById('pTitle').innerText = track.title;
            renderQueue(); 
            
            setStatus("Downloading to Cache...", true);
            document.getElementById('btnPlayPause').innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

            try {
                // Clear previous song from internal cache
                if ('caches' in window) {
                    const c = await caches.open('music-cache');
                    await c.delete('/virtual-song.mp3');
                }

                // Call Server to Fetch Song (Wait for full download)
                const res = await fetch(`/fetch_song?url=${encodeURIComponent(track.url)}&session_id=${sessionId}`);
                if (!res.ok) throw new Error("Download Error");

                // Save to Internal Cache (Disk)
                const cache = await caches.open('music-cache');
                await cache.put('/virtual-song.mp3', res);

                setStatus("Playing", false);
                playAudio(track);

            } catch(e) {
                setStatus("Download Failed. Skipping...", false);
                setTimeout(playNext, 2000); // Auto-skip on error
            }
        }

        // --- PLAYBACK ---
        function playAudio(track) {
            const player = document.getElementById('player');
            // Play from Virtual URL (Intercepted by Service Worker)
            player.src = '/virtual-song.mp3?t=' + Date.now();
            
            player.play().then(() => {
                isPlaying = true;
                updatePlayBtn();
                setupLockScreen(track);
            }).catch(e => console.log("Auto-play blocked:", e));
        }

        function togglePlay() {
            const player = document.getElementById('player');
            if(player.paused) { player.play(); isPlaying = true; }
            else { player.pause(); isPlaying = false; }
            updatePlayBtn();
        }

        function updatePlayBtn() {
            const btn = document.getElementById('btnPlayPause');
            btn.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>';
        }

        // --- CONTROLS ---
        function playNext() {
            let next = currentIndex + 1;
            if(next >= queue.length) next = 0; // Loop list
            loadSong(next);
        }

        function playPrev() {
            let prev = currentIndex - 1;
            if(prev < 0) prev = queue.length - 1; // Loop list
            loadSong(prev);
        }

        function toggleRepeat() {
            const btn = document.getElementById('btnRepeat');
            repeatMode = (repeatMode + 1) % 3;
            if(repeatMode === 0) { btn.className = "btn-ctrl"; btn.innerHTML = '<i class="fas fa-repeat"></i>'; } // Off
            if(repeatMode === 1) { btn.className = "btn-ctrl active-mode"; btn.innerHTML = '<i class="fas fa-repeat"></i>'; } // All
            if(repeatMode === 2) { btn.className = "btn-ctrl active-mode"; btn.innerHTML = '1'; } // One
        }

        // --- AUTO-DJ LOGIC ---
        document.getElementById('player').onended = () => {
            if(repeatMode === 2) {
                document.getElementById('player').currentTime = 0;
                document.getElementById('player').play();
            } else {
                playNext();
            }
        };

        // --- LOCK SCREEN CONTROLS ---
        function setupLockScreen(track) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata({
                    title: track.title,
                    artist: "Music App",
                    artwork: [{ src: track.thumbnail, sizes: '512x512', type: 'image/png' }]
                });
                navigator.mediaSession.setActionHandler('play', () => { document.getElementById('player').play(); isPlaying = true; updatePlayBtn(); });
                navigator.mediaSession.setActionHandler('pause', () => { document.getElementById('player').pause(); isPlaying = false; updatePlayBtn(); });
                navigator.mediaSession.setActionHandler('previoustrack', playPrev);
                navigator.mediaSession.setActionHandler('nexttrack', playNext);
            }
        }

        // --- SAVE FUNCTION ---
        function saveSong() {
            const a = document.createElement('a');
            a.href = '/virtual-song.mp3'; // Service Worker serves this from Cache
            a.download = queue[currentIndex].title + ".m4a";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        function setStatus(msg, isLoading) {
            document.getElementById('statusText').innerText = msg;
            const loader = document.getElementById('loader');
            if(isLoading) loader.classList.add('loading');
            else loader.classList.remove('loading');
        }

        document.getElementById('query').addEventListener('keypress', (e) => { if(e.key === 'Enter') performSearch(); });
    </script>
</body>
</html>
