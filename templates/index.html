<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Music App</title>
    <style>
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #1db954; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; }
        h1 { color: var(--accent); margin-bottom: 20px; }
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 15px; border-radius: 30px; border: none; background: #333; color: white; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 0 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        .card { background: var(--card); border-radius: 12px; padding: 20px; display: none; flex-direction: column; align-items: center; margin-top: 20px;}
        img { width: 100%; border-radius: 8px; margin-bottom: 15px; }
        
        .btn-main { background: white; color: black; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; cursor: pointer; border: none;}
        .btn-main:disabled { background: #555; color: #888; }
        
        .play-only-btn { background: var(--accent); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 15px; width: 100%; border: none; cursor: pointer; display: none; font-size: 1.2rem; }
        
        audio { width: 100%; margin-top: 20px; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid #555; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status { margin-top: 10px; color: #888; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Music App</h1>
        <div class="search-box">
            <input type="text" id="query" placeholder="Song name...">
            <button onclick="search()">Go</button>
        </div>
        <div id="loader" class="spinner" style="margin: 0 auto;"></div>
        
        <div class="card" id="card">
            <img id="thumb" src="">
            <h3 id="title" style="text-align: center;"></h3>
            <div id="artist" style="color: #bbb; font-size: 0.9rem; margin-bottom: 10px;"></div>
            
            <button class="btn-main" id="bufferBtn" onclick="bufferSong()">
                <div class="spinner" id="btnSpin"></div>
                <span id="btnText">Prepare Song</span>
            </button>
            
            <button class="play-only-btn" id="playNowBtn" onclick="playFromMemory()">
                â–¶ Play Song
            </button>
            
            <div id="status"></div>
            <audio id="player" controls controlsList="nodownload"></audio>
        </div>
    </div>

    <script>
        const sessionId = "sess_" + Date.now();
        let currentMemoryBlobUrl = null;
        let currentMetadata = {}; // Store title/image for lockscreen

        async function search() {
            const q = document.getElementById('query').value;
            if(!q) return;
            
            if (currentMemoryBlobUrl) { URL.revokeObjectURL(currentMemoryBlobUrl); currentMemoryBlobUrl = null; }

            document.getElementById('card').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('player').pause();
            
            try {
                const res = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Session-ID': sessionId },
                    body: JSON.stringify({query: q})
                });
                const data = await res.json();
                document.getElementById('loader').style.display = 'none';
                
                if(res.ok) {
                    currentMetadata = {
                        title: data.title,
                        artist: "YouTube Stream",
                        artwork: [{ src: data.thumbnail, sizes: '512x512', type: 'image/png' }]
                    };

                    document.getElementById('thumb').src = data.thumbnail;
                    document.getElementById('title').innerText = data.title;
                    document.getElementById('card').style.display = 'flex';
                    document.getElementById('bufferBtn').dataset.url = data.url;
                    resetUI();
                }
            } catch(e) { alert("VPN Error"); }
        }

        async function bufferSong() {
            const url = document.getElementById('bufferBtn').dataset.url;
            const status = document.getElementById('status');
            
            document.getElementById('bufferBtn').disabled = true;
            document.getElementById('btnSpin').style.display = 'block';
            document.getElementById('btnText').innerText = "Caching...";
            status.innerText = "Downloading to browser memory...";

            try {
                const res = await fetch(`/fetch_song?url=${encodeURIComponent(url)}&session_id=${sessionId}`);
                if (!res.ok) throw new Error("Download failed");

                const blob = await res.blob(); 
                currentMemoryBlobUrl = URL.createObjectURL(blob);

                status.innerText = "Ready to play.";
                document.getElementById('bufferBtn').style.display = 'none';
                document.getElementById('playNowBtn').style.display = 'block';

            } catch (err) {
                status.innerText = "Error: " + err.message;
                resetUI();
            }
        }

        function playFromMemory() {
            const player = document.getElementById('player');
            player.src = currentMemoryBlobUrl;
            player.style.display = 'block';
            
            player.play()
            .then(() => {
                // --- CRITICAL: LOCK SCREEN CONTROLS ---
                // This tells Android "I am a media app, keep me alive!"
                if ('mediaSession' in navigator) {
                    navigator.mediaSession.metadata = new MediaMetadata(currentMetadata);
                    
                    navigator.mediaSession.setActionHandler('play', function() { player.play(); });
                    navigator.mediaSession.setActionHandler('pause', function() { player.pause(); });
                    navigator.mediaSession.setActionHandler('stop', function() { 
                        player.pause(); 
                        player.currentTime = 0;
                    });
                }
            })
            .catch(e => console.log("Play failed", e));
            
            player.onended = () => {
                document.getElementById('status').innerText = "Finished. Memory cleared.";
                URL.revokeObjectURL(currentMemoryBlobUrl); 
                currentMemoryBlobUrl = null;
                resetUI();
            };
        }

        function resetUI() {
            document.getElementById('bufferBtn').disabled = false;
            document.getElementById('bufferBtn').style.display = 'flex';
            document.getElementById('btnText').innerText = "Prepare Song";
            document.getElementById('btnSpin').style.display = 'none';
            document.getElementById('playNowBtn').style.display = 'none';
            document.getElementById('player').style.display = 'none';
        }
        
        document.getElementById('query').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchSong();
        });
    </script>
</body>
</html>
