<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#1db954">
    <title>Music App</title>
    <style>
        /* --- Dark Theme --- */
        :root { --bg: #121212; --card: #1e1e1e; --text: #fff; --accent: #1db954; }
        body { background: var(--bg); color: var(--text); font-family: sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        .container { width: 100%; max-width: 500px; padding-bottom: 50px; }
        h1 { color: var(--accent); margin-bottom: 20px; }
        
        .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
        input { flex: 1; padding: 15px; border-radius: 30px; border: none; background: #333; color: white; outline: none; }
        button { background: var(--accent); color: white; border: none; padding: 0 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }
        
        .card { background: var(--card); border-radius: 12px; padding: 20px; display: none; flex-direction: column; align-items: center; margin-top: 20px; width: 100%; box-sizing: border-box; }
        img { width: 100%; border-radius: 8px; margin-bottom: 15px; }
        
        .btn-main { background: white; color: black; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 20px; width: 100%; display: flex; justify-content: center; gap: 10px; cursor: pointer; border: none;}
        .btn-main:disabled { background: #555; color: #888; }
        
        .play-only-btn { background: var(--accent); color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; margin-top: 15px; width: 100%; border: none; cursor: pointer; display: none; font-size: 1.2rem; }
        
        audio { width: 100%; margin-top: 20px; display: none; }
        .spinner { width: 20px; height: 20px; border: 3px solid #555; border-top: 3px solid var(--accent); border-radius: 50%; animation: spin 1s infinite; display: none; }
        @keyframes spin { to { transform: rotate(360deg); } }
        #status { margin-top: 10px; color: #888; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Music App</h1>
        <div class="search-box">
            <input type="text" id="query" placeholder="Song name..." enterkeyhint="search">
            <button onclick="search()">Go</button>
        </div>
        <div id="loader" class="spinner" style="margin: 0 auto;"></div>
        
        <div class="card" id="card">
            <img id="thumb" src="">
            <h3 id="title" style="text-align: center;"></h3>
            
            <!-- Step 1: Buffer Button -->
            <button class="btn-main" id="bufferBtn" onclick="bufferSong()">
                <div class="spinner" id="btnSpin"></div>
                <span id="btnText">Prepare Song</span>
            </button>
            
            <!-- Step 2: Play Button (Hidden initially) -->
            <button class="play-only-btn" id="playNowBtn" onclick="playSong()">
                â–¶ Play Song
            </button>
            
            <div id="status"></div>
            <audio id="player" controls controlsList="nodownload"></audio>
        </div>
    </div>

    <script>
        const sessionId = "sess_" + Date.now();
        let currentMetadata = {};
        // Keep audio context alive hack
        let audioCtx; 

        // 1. Install Service Worker (Background Engine)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(() => console.log("Background Audio Ready"))
                .catch(err => console.log("SW Fail", err));
        }

        async function search() {
            const q = document.getElementById('query').value;
            if(!q) return;
            
            // Clean up old cache
            if ('caches' in window) {
                caches.open('music-cache').then(cache => {
                    cache.delete('/virtual-song.mp3');
                });
            }

            document.getElementById('card').style.display = 'none';
            document.getElementById('loader').style.display = 'block';
            document.getElementById('player').pause();
            
            try {
                const res = await fetch('/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'X-Session-ID': sessionId },
                    body: JSON.stringify({query: q})
                });
                const data = await res.json();
                document.getElementById('loader').style.display = 'none';
                
                if(res.ok) {
                    currentMetadata = { 
                        title: data.title, 
                        artist: "Music App", 
                        artwork: [{ src: data.thumbnail, sizes: '512x512', type: 'image/png' }] 
                    };
                    document.getElementById('thumb').src = data.thumbnail;
                    document.getElementById('title').innerText = data.title;
                    document.getElementById('card').style.display = 'flex';
                    document.getElementById('bufferBtn').dataset.url = data.url;
                    resetUI();
                }
            } catch(e) { alert("VPN Error"); }
        }

        async function bufferSong() {
            const url = document.getElementById('bufferBtn').dataset.url;
            const status = document.getElementById('status');
            
            // Initialize Audio Context on user gesture to keep thread alive
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            document.getElementById('bufferBtn').disabled = true;
            document.getElementById('btnSpin').style.display = 'block';
            document.getElementById('btnText').innerText = "Caching...";
            status.innerText = "Downloading to App Cache...";

            try {
                // Call Server and WAIT for full download
                const res = await fetch(`/fetch_song?url=${encodeURIComponent(url)}&session_id=${sessionId}`);
                if (!res.ok) throw new Error("Download failed");

                // Save to Persistent Cache
                const cache = await caches.open('music-cache');
                await cache.put('/virtual-song.mp3', res);

                status.innerText = "Cached. Ready to Play.";
                document.getElementById('bufferBtn').style.display = 'none';
                document.getElementById('playNowBtn').style.display = 'block';

            } catch (err) {
                status.innerText = "Error: " + err.message;
                resetUI();
            }
        }

        function playSong() {
            const player = document.getElementById('player');
            
            // Play from Virtual URL
            player.src = '/virtual-song.mp3?t=' + Date.now();
            player.style.display = 'block';
            
            player.play()
            .then(() => {
                updateMediaSession("playing");
            })
            .catch(e => console.log("Play error:", e));
            
            document.getElementById('status').innerText = "Playing in Background Mode.";
            document.getElementById('playNowBtn').style.display = 'none';
            
            // Listeners to update state
            player.addEventListener('play', () => updateMediaSession("playing"));
            player.addEventListener('pause', () => updateMediaSession("paused"));

            // Auto-Delete from Cache when finished
            player.onended = () => {
                document.getElementById('status').innerText = "Finished. Cache cleared.";
                updateMediaSession("none");
                caches.open('music-cache').then(cache => {
                    cache.delete('/virtual-song.mp3');
                });
                resetUI();
            };
        }

        // --- CRITICAL: FORCE ANDROID TO KNOW WE ARE PLAYING ---
        function updateMediaSession(state) {
            if ('mediaSession' in navigator) {
                navigator.mediaSession.metadata = new MediaMetadata(currentMetadata);
                
                // Explicitly set playback state
                navigator.mediaSession.playbackState = state;

                navigator.mediaSession.setActionHandler('play', () => {
                    document.getElementById('player').play();
                    navigator.mediaSession.playbackState = "playing";
                });
                navigator.mediaSession.setActionHandler('pause', () => {
                    document.getElementById('player').pause();
                    navigator.mediaSession.playbackState = "paused";
                });
                navigator.mediaSession.setActionHandler('previoustrack', () => { 
                    document.getElementById('player').currentTime = 0; 
                });
            }
        }

        function resetUI() {
            document.getElementById('bufferBtn').disabled = false;
            document.getElementById('bufferBtn').style.display = 'flex';
            document.getElementById('btnText').innerText = "Prepare Song";
            document.getElementById('btnSpin').style.display = 'none';
            document.getElementById('playNowBtn').style.display = 'none';
            document.getElementById('player').style.display = 'none';
        }
        
        document.getElementById('query').addEventListener('keypress', function (e) {
            if (e.key === 'Enter') searchSong();
        });
    </script>
</body>
</html>
